# 第4章 Opteronの命令キャッシュとデコーディング

- 4.1 命令キャッシュ: 1つ以上の命令を格納する
- 4.2 一般的な命令フォーマット
- 4.3 プリデコードビット
- 4.4 高並列プリデコーディング
- 4.5 高負荷の分岐予測
- 4.6 向上した分岐予測
- 4.7 分岐セレクタ
- 4.8 分岐ターゲットバッファ
- 4.9 グローバルヒストリ2モードカウンタ
- 4.10 1ライン当たり3分岐のローカル&グローバル分岐予測
- 4.11 分岐ターゲットアドレス計算、分岐ターゲットバッファのバックアップ
- 4.12 命令キャッシュヒット/ミスの決定。現在のページとBTAC
- 4.13 命令キャッシュスヌーピング

![Opteron's Instruction and Decoding Pipeline](Opteron_Instr_Cache.jpg)

## 4.1 命令キャッシュ: 1つ以上の命令を格納する

命令キャッシュへのアクセスは128ビット幅である。
1サイクルで16バイト分の命令がキャッシュにロードされる。
命令のバイト列は、76ビットの付加情報を持っている。
この拡張ビットにより、キャッシュポートからロードされる命令の全体ビット幅は204ビットとなる。
しかしまだ私達はフル命令キャッシュをカバーするだけのビットしか数えていない。
つまり、1024個のキャッシュラインは、それぞれ付加ビットを持っている。
これらは1024エントリよりも少ない、さらに多くのフィールドを持っており、キャッシュラインの一部でのみ有効となる。

|                        | Instruction only | Total Size |
|------------------------|------------------|------------|
| Instruction Cache size | 64 kByte         | 102 kByte  |
| Cache Line size        | 64 Byte          | 102 Byte   |
| One Read Port          | 128 bit          | 204 bit    |
| One Write Port         | 128 bit          | 204 bit    |

良く知られているのは、各バイトに付加されているプリデコードビットと呼ばれる3ビットのデータである。
これらのビットは、複雑なx86可変長命令の先頭と最後尾にマークされ、いくつかの機能的な情報を提供する。
残りの2ビットフィールドはパリティビットであり、1つは16ビットデータ毎に付加され、一般に分岐セレクタと呼ばれる
(16バイトラインの命令コードにつき、2ビットのパリティビットが8つ分付加される)。

Opteronの分岐セレクタは他のAthlon(32)とは異なり、全ての命令キャッシュ中の1024キャッシュライン全てをカバーすることができる。
分岐セレクタには、プリデコード情報として探索することができない、ローカル分岐予測情報が含まれている。
いくつかのコードは分岐セレクタが有効な意味を持つまでに複数回実行される。

キャッシュラインが破棄されたとしても、分岐セレクタビットが統合された2次キャッシュの命令データに保存されているのはこのような理由である。
分岐セレクタは各バイトに余分な1ビットとして付加される。
レベル2キャッシュはこのビットをECC(Error Coding and Correction)情報のために保持している。
ECCはデータキャッシュラインでしか利用されず、命令キャッシュラインでは利用されない。
後者ではECCは必要ないので、キャッシュライン中のいくつかのパリティビットを格納するのには十分である。
命令キャッシュラインにおいて衝突したものは、常に外部DRAMメモリから取得される。

|                  | Ram Size  | Bus Size | Comments                                                        |
|------------------|-----------|----------|-----------------------------------------------------------------|
| Instruction Code | 64 kByte  | 128 bit  | 16 bytes instruction code                                       |
| Parity bits      | 4 kByte   | 8 bit    | One parity bit for each 16 bit                                  |
| Pre-decode       | 26 kByte  | 52 bit   | 3 bits per byte (start, end, function) + 4 bit per 16 byte line |
| Branch Selectors | 8 kByte   | 16 bit   | 2 bits for each 2 bytes of instruction code                     |
| TOTAL            | 102 kByte | 204 bit  |                                                                 |

![Opteron's Instruction Cache](Opteron_Instruction_Cache_Ill.jpg)

## 4.2 一般的な命令フォーマット

64ビット命令の簡単な概要である。

連続したプリフィックスを、実際の命令の前に付加することができる。
最初は、レガシーなプリフィックスが付加される。
最も重要なレガシープリフィックスはオペランドサイズをオーバライドするプリフィックス(hex 66)と、アドレスサイズのオーバライドプリフィックス(hex 67)である。
これらのプリフィックスは、ディスプレースメントと即値フィールドの長さを、1,2,4バイトの長さに変更することができるため、全体の命令長を決定する。

REXプリフィックス(hex 4X)は、64ビットの新しいプリフィックスで、64ビット処理を可能にする。
Xの値は汎用レジスタとSSEレジスタの数を8から16に拡張する際に使用する。
x86は、データやアドレスを指定するために1命令あたり最大で3つのレジスタを指定するため、これらのビットはその目的に利用される。
4番目のビットはオペランドのサイズをオーバライドするために使用される(デフォルトサイズか、64ビットに拡張される)。

Escapeプリフィックス(hex 0F)はSSE命令を特定するために利用される。
オペコードは実際にはプリフィックスの後から始まる。
1から2バイトのオプショナルなMODRMバイトとSIBバイトを付加することができる。
オプションのディスプレースメントと即値フィールドは、アドレスおよびデータの計算のために定数を格納することができ、1,2,4バイトのうちどれかを取ることができる。
命令全体の長さは、15バイトまでに制限される。

![Opteron's Instruction Format](Opteron_instruction_format_780x200.jpg)
